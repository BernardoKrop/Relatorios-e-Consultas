/*
---------------------------------------------------------------
Query para Relatório de Ocorrências de Itens em NF de Entrada
Criador: Bernardo da Silva Kropiwiec
Data: 02/05/2025
Área responsável pela solicitação: Contabil

Descrição:
Essa consulta busca todas as ocorrências de um item em Notas Fiscais de Entrada, 
com o objetivo de aprimorar a gestão de estoque e o planejamento de compras.
Inclui, adicionalmente, o nº e a data do documento mais recente associados a cada item.
---------------------------------------------------------------
*/

WITH UltDoc AS (
    SELECT
        p1."ItemCode",
        o1."DocNum"  AS "LastDocNum",
        o1."DocDate" AS "LastDocDate",
        ROW_NUMBER() OVER (
            PARTITION BY p1."ItemCode"
            ORDER BY     o1."DocDate" DESC,      -- mais recente primeiro
                         o1."DocNum"  DESC       -- desempate, opcional
        ) AS rn
    FROM OPCH o1
    JOIN PCH1 p1 ON o1."DocEntry" = p1."DocEntry"
    WHERE o1."CANCELED" = 'N'
)

SELECT
    grp."ItmsGrpCod"               AS "Código Grupo",
    grp."ItmsGrpNam"               AS "Nome Grupo",
    it."ItemCode"                  AS "Código Item",
    it."Dscription"                AS "Nome Item",
    it."UomCode"                   AS "Unidade Medida",
    COUNT(it."ItemCode")           AS "Ocorrencias em NF",
    SUM(it."Quantity")             AS "Volume Total",
    ult."LastDocNum"               AS "Nr Última NF",
    TO_DATE(ult."LastDocDate")     AS "Data Última NF"
FROM       OPCH nfe
JOIN       PCH1 it   ON nfe."DocEntry"   = it."DocEntry"
LEFT JOIN  OITM prod ON it."ItemCode"    = prod."ItemCode"
LEFT JOIN  OITB grp  ON prod."ItmsGrpCod"= grp."ItmsGrpCod"
LEFT JOIN  UltDoc ult ON ult."ItemCode"  = it."ItemCode"
                     AND ult.rn = 1       -- garante só a linha mais recente
WHERE nfe."CANCELED" = 'N'
  AND it."Quantity"  > 0
GROUP BY
    grp."ItmsGrpCod",
    grp."ItmsGrpNam",
    it."ItemCode",
    it."Dscription",
    it."UomCode",
    ult."LastDocNum",
    ult."LastDocDate"
ORDER BY it."UomCode";
