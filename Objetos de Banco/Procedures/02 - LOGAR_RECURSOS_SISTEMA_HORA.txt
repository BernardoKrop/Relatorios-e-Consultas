CREATE OR REPLACE PROCEDURE LOGAR_RECURSOS_SISTEMA_HORA()
AS
BEGIN  
    -- Variáveis para uso de memória
    DECLARE MEMORIA_MEDIA_USADA DECIMAL(20,2);
    DECLARE MEMORIA_PICO_USADA DECIMAL(20,2);
    DECLARE MEMORIA_MEDIANA_USADA DECIMAL(20,2);
    DECLARE MEMORIA_MINIMA_USADA DECIMAL(20,2);
    DECLARE MEMORIA_MAXIMA_USADA DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_TOTAL DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_USADO DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_DATA DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_LOG DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_TRACE DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_DATA_BACKUP DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_LOG_BACKUP DECIMAL(20,2);
    DECLARE DISCO_TAMANHO_CATALOG_BACKUP DECIMAL(20,2);
    
    -- Coletando os dados de uso de memória
    SELECT 
        MAX(ROUND(INSTANCE_TOTAL_MEMORY_PEAK_USED_SIZE/1024/1024/1024, 2)),
        ROUND(AVG(INSTANCE_TOTAL_MEMORY_USED_SIZE)/1024/1024/1024, 2),
        ROUND(MEDIAN(INSTANCE_TOTAL_MEMORY_USED_SIZE)/1024/1024/1024, 2),
        MIN(ROUND(INSTANCE_TOTAL_MEMORY_USED_SIZE/1024/1024/1024, 2)),
        MAX(ROUND(INSTANCE_TOTAL_MEMORY_USED_SIZE/1024/1024/1024, 2))
      INTO 
        MEMORIA_PICO_USADA,
        MEMORIA_MEDIA_USADA,
        MEMORIA_MEDIANA_USADA,
        MEMORIA_MINIMA_USADA,
        MEMORIA_MAXIMA_USADA
      FROM 
        _SYS_STATISTICS.HOST_RESOURCE_UTILIZATION_STATISTICS
      WHERE 
        HOST = 'saphamultifazendas'
        AND TO_TIMESTAMP(SERVER_TIMESTAMP) BETWEEN ADD_SECONDS(CURRENT_TIMESTAMP, -3600) AND CURRENT_TIMESTAMP;
       
       
   --Coleta de informação sobre uso de disco
   
    SELECT ROUND(TOTAL_SIZE/1024/1024/1024, 2),
           ROUND(USED_SIZE/1024/1024/1024, 2)
      INTO DISCO_TAMANHO_TOTAL, DISCO_TAMANHO_USADO
      FROM SYS.M_DISKS 
    WHERE USAGE_TYPE = 'DATA';
    
    SELECT ROUND(USED_SIZE/1024/1024/1024, 2)
      INTO DISCO_TAMANHO_DATA
      FROM M_DISK_USAGE
    WHERE USED_SIZE > 0
      AND USAGE_TYPE = 'DATA';
  
    SELECT ROUND(USED_SIZE/1024/1024/1024, 2)
      INTO DISCO_TAMANHO_LOG
      FROM M_DISK_USAGE
    WHERE USED_SIZE > 0
      AND USAGE_TYPE = 'LOG';
  
    SELECT ROUND(USED_SIZE/1024/1024/1024, 2)
      INTO DISCO_TAMANHO_TRACE
      FROM M_DISK_USAGE
    WHERE USED_SIZE > 0
      AND USAGE_TYPE = 'TRACE';
     
     ----------------------
     
     SELECT ROUND(USED_SIZE/1024/1024/1024, 2)
      INTO DISCO_TAMANHO_DATA_BACKUP
      FROM M_DISK_USAGE
    WHERE USAGE_TYPE = 'DATA_BACKUP';
  
    SELECT ROUND(USED_SIZE/1024/1024/1024, 2)
      INTO DISCO_TAMANHO_LOG_BACKUP
      FROM M_DISK_USAGE
    WHERE USED_SIZE > 0
      AND USAGE_TYPE = 'LOG_BACKUP';
  
    SELECT ROUND(USED_SIZE/1024/1024/1024, 2)
      INTO DISCO_TAMANHO_CATALOG_BACKUP
      FROM M_DISK_USAGE
    WHERE USED_SIZE > 0
      AND USAGE_TYPE = 'CATALOG_BACKUP';   

    -- Inserindo os dados na tabela de logs
    INSERT INTO "SBOTRUSTAGRO".LOG_RECURSOS_SISTEMA_HORA(
        DATA_LOG,
        MEMORIA_MEDIA_USADA,
        MEMORIA_PICO_USADA,
        MEMORIA_MEDIANA_USADA,
        MEMORIA_MINIMA_USADA,
        MEMORIA_MAXIMA_USADA,
        DISCO_TAMANHO_TOTAL,
        DISCO_TAMANHO_USADO,
        DISCO_TAMANHO_DATA,
        DISCO_TAMANHO_LOG,
        DISCO_TAMANHO_TRACE,
        DISCO_TAMANHO_DATA_BACKUP,
        DISCO_TAMANHO_LOG_BACKUP,
        DISCO_TAMANHO_CATALOG_BACKUP)
    VALUES (
        CURRENT_TIMESTAMP, 
        MEMORIA_MEDIA_USADA,
        MEMORIA_PICO_USADA,
        MEMORIA_MEDIANA_USADA,
        MEMORIA_MINIMA_USADA,
        MEMORIA_MAXIMA_USADA,
        DISCO_TAMANHO_TOTAL,
        DISCO_TAMANHO_USADO,
        DISCO_TAMANHO_DATA,
        DISCO_TAMANHO_LOG,
        DISCO_TAMANHO_TRACE,
        DISCO_TAMANHO_DATA_BACKUP,
        DISCO_TAMANHO_LOG_BACKUP,
        DISCO_TAMANHO_CATALOG_BACKUP
    );
END;